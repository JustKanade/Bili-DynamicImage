name: Release Pre-build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¯»å–æ’ä»¶ç‰ˆæœ¬
      id: get_version
      run: |
        VERSION=$(jq -r '.version' manifest.json)
        echo "plugin_version=$VERSION" >> $GITHUB_OUTPUT
        echo "æ’ä»¶ç‰ˆæœ¬: $VERSION"
        
    - name: åˆ›å»ºå‹ç¼©åŒ…
      run: |
        PLUGIN_VERSION="${{ steps.get_version.outputs.plugin_version }}"
        ZIP_NAME="Bili-DynamicImage-v${PLUGIN_VERSION}.zip"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p temp_build
        
        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•ï¼Œæ’é™¤æŒ‡å®šæ–‡ä»¶å’Œæ–‡ä»¶å¤¹
        rsync -av --progress . temp_build/ \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='.readme' \
          --exclude='LICENSE' \
          --exclude='.gitignore' \
          --exclude='README.md' \
          --exclude='temp_build'
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd temp_build
        zip -r "../${ZIP_NAME}" .
        cd ..
        
        echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV
        echo "åˆ›å»ºå‹ç¼©åŒ…: ${ZIP_NAME}"
        
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        PLUGIN_VERSION="${{ steps.get_version.outputs.plugin_version }}"
        cat << EOF > release_notes.md
        ## Bili-DynamicImage v${PLUGIN_VERSION} é¢„å‘å¸ƒç‰ˆæœ¬
        
        ### ğŸ“¦ æ’ä»¶ä¿¡æ¯
        - **ç‰ˆæœ¬**: v${PLUGIN_VERSION}
        - **ç±»å‹**: Chromeæ‰©å±•æ’ä»¶
        - **åŠŸèƒ½**: ä¸‹è½½Bç«™åŠ¨æ€é¡µé¢å›¾ç‰‡ï¼Œæ”¯æŒæ‰¹é‡ä¸‹è½½
        
        ### âœ¨ ä¸»è¦åŠŸèƒ½
        - ğŸ–¼ï¸ æ‰¹é‡ä¸‹è½½Bç«™åŠ¨æ€ä¸­çš„å›¾ç‰‡
        - ğŸ¯ æ”¯æŒä¸ªäººç©ºé—´åŠ¨æ€é¡µé¢
        - ğŸš€ ä¸€é”®ä¸‹è½½ï¼Œæ“ä½œç®€ä¾¿
        - ğŸ“± é€‚é…å¤šç§åŠ¨æ€ç±»å‹
        
        ### ğŸ“¥ å®‰è£…è¯´æ˜
        1. ä¸‹è½½ä¸‹æ–¹çš„ \`${ZIP_NAME}\` æ–‡ä»¶
        2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
        3. æ‰“å¼€Chromeæµè§ˆå™¨ï¼Œè¿›å…¥æ‰©å±•ç®¡ç†é¡µé¢ (chrome://extensions/)
        4. å¼€å¯"å¼€å‘è€…æ¨¡å¼"
        5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
        6. å®‰è£…å®Œæˆï¼Œåœ¨Bç«™åŠ¨æ€é¡µé¢å³å¯ä½¿ç”¨
        
        ### ğŸŒ æ”¯æŒé¡µé¢
        - https://t.bilibili.com/* (åŠ¨æ€é¡µé¢)
        - https://space.bilibili.com/*/dynamic* (ä¸ªäººç©ºé—´åŠ¨æ€)
        - https://www.bilibili.com/opus/* (å›¾æ–‡åŠ¨æ€)
        
        ### âš ï¸ æ³¨æ„äº‹é¡¹
        - æ­¤ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½
        - å»ºè®®åœ¨ä½¿ç”¨å‰å¤‡ä»½é‡è¦æ•°æ®
        - å¦‚é‡é—®é¢˜è¯·åŠæ—¶åé¦ˆ
        
        ---
        
        **ä¸‹è½½æ–‡ä»¶**: \`${ZIP_NAME}\`  
        **å‘å¸ƒæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        EOF
        
        echo "å‘å¸ƒè¯´æ˜å·²ç”Ÿæˆ"
        
    - name: åˆ›å»ºé¢„å‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: "Bili-DynamicImage ${{ github.event.inputs.version }} (é¢„å‘å¸ƒ)"
        body_path: release_notes.md
        prerelease: true
        files: ${{ env.ZIP_NAME }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      run: |
        rm -rf temp_build
        rm -f release_notes.md
        echo "æ¸…ç†å®Œæˆ" 